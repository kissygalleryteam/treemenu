/*! treemenu - v1.0 - 2013-09-24 11:33:18 AM
* Copyright (c) 2013 moxiao; Licensed  */
KISSY.add("gallery/treemenu/1.0/index",function(a,b,c){function d(a){var b=this;d.superclass.constructor.call(b,a),b.cfg=a}return b.all,a.extend(d,c,{_init:function(){var c=this;c.cfgCopy=a.clone(c.cfg),c.cfg=a.merge({container:"#menu",unfold:!1,unfoldAll:!1,unique:!1,anim:!0,selectable:!0,name:"treemenu",style:"gray-dot",titleRender:function(a){return a.title}},c.cfg),c.container=a.isString(c.cfg.container)?b.one(c.cfg.container):c.cfg.container,c._renderAndBindEvt()},_renderAndBindEvt:function(){var a=this;if(a.allMenuObj=[],a.maxLevel=0,a.container){a.container.html(a._renderMenu(a.cfg,0)),b.all("dt",a.container).delegate("click mouseover mouseout","q",function(c){var d=b.one(this),e=d.parent("dl"),f=Number(d.attr("idx")),g=b.one(c.currentTarget);"click"==c.type?a.allMenuObj[f].unfold?(a._foldNode(e),a.allMenuObj[f].unfold=!1,a.fire("fold",{entity:a.allMenuObj[f]})):(a._unfoldNode(e),a.allMenuObj[f].unfold=!0,a.fire("unfold",{entity:a.allMenuObj[f]}),a.cfg.unique&&d.parent("dd")&&d.parent("dd").siblings("dd").each(function(b){var c=Number(b.attr("idx")),d=a.allMenuObj[c];!d.isLeaf&&d.unfold&&(a._foldNode(b.one("dl"),!1),d.unfold=!1,a.fire("unfold",{entity:d}))})):"mouseover"==c.type?(g.addClass(a._getStyle("mouseover-node")),a.fire("mouseover",{entity:a.allMenuObj[f]})):(g.removeClass(a._getStyle("mouseover-node")),a.fire("mouseout",{entity:a.allMenuObj[f]}))}),b.all("dd."+a._getStyle("leaf"),a.container).delegate("click mouseover mouseout","q",function(c){var d=b.one(c.currentTarget),e=Number(b.one(this).attr("idx")),f=a.allMenuObj[e];"click"==c.type?(a.cfg.selectable&&(a.cfg.lastSelectedLeaf&&(a.cfg.lastSelectedLeaf.obj.selected=!1,a.cfg.lastSelectedLeaf.node.removeClass(a._getStyle("selected"))),a.cfg.lastSelectedLeaf={node:d,obj:f},d.addClass(a._getStyle("selected")),d.removeClass(a._getStyle("mouseover-leaf"))),f.selected=!0,a.fire("select",{entity:f})):"mouseover"==c.type?(f.selected||d.addClass(a._getStyle("mouseover-leaf")),a.fire("mouseover",{entity:f})):(d.removeClass(a._getStyle("mouseover-leaf")),a.fire("mouseout",{entity:f}))});var c=b.one("q."+a._getStyle("selected")),d=null;c&&(d=a.allMenuObj[Number(c.parent("dd").attr("idx"))],a.cfg.lastSelectedLeaf={node:c,obj:d})}},_unfoldNode:function(a,b){b=null==b?!0:b;var c=a.children("dt"),d=a.children("dd");c.replaceClass(this._getStyle("fold"),this._getStyle("unfold")),b&&this.cfg.anim?d.fadeIn(.32):d.show()},_foldNode:function(a,b){b=null==b?!0:b;var c=a.children("dt"),d=a.children("dd");c.replaceClass(this._getStyle("unfold"),this._getStyle("fold")),b&&this.cfg.anim?d.fadeOut(.16):d.hide()},_renderMenu:function(a,b){a.level=b,a.index=this.allMenuObj.length,a.isLeaf="undefined"==typeof a.subMenu,a.unfold="undefined"==typeof a.unfold?!1:a.unfold,a.selected="undefined"==typeof a.selected?!1:a.selected;var c=[],d=0,e=this.allMenuObj.length,f=this.cfg.unfoldAll||a.unfold?"":'style="display:none"',g=this.cfg.unfoldAll||a.unfold?this._getStyle("unfold"):this._getStyle("fold"),h=this._getStyle(0==b?"menu":"submenu"),i=a.selected?this._getStyle("selected"):"",j=this._getStyle("quto"),k=a.tip&&a.tip.length>0?'title="'+a.tip+'"':"",l=null,m=null;if(this.maxLevel=Math.max(this.maxLevel,b),this.allMenuObj.push(a),a.subMenu){for(c.push('<dl class="'+h+'">'),c.push('<dt class="'+g+'" idx="'+e+'"><q '+this._getClass(j)+" "+k+">"+this.cfg.titleRender(a)+"</q></dt>"),d=0;d<a.subMenu.length;d++)l=d!=a.subMenu.length-1?"":this._getStyle("last"),m=a.subMenu[d].subMenu?"":this._getStyle("leaf"),c.push("<dd "+this._getClass(l,m)+" "+f+' idx="'+this.allMenuObj.length+'">'),c.push('<p class="'+this._getStyle("cross")+'"></p>'),c.push(this._renderMenu(a.subMenu[d],b+1)),c.push("</dd>");c.push("</dl>")}else c.push("<q "+this._getClass(j,i)+" "+k+">"+this.cfg.titleRender(a)+"</q>");return c.join("")},_getStyle:function(a){return this.cfg.name+"-"+this.cfg.style+"-"+a},_getClass:function(){if(0==arguments.length)return"";var a=[],b=0;for(b=0;b<arguments.length;b++)null!=arguments[b]&&arguments[b].length>0&&a.push(arguments[b]);return'class="'+a.join(" ")+'"'},render:function(){this._init()},unfoldAll:function(){var b=this;b.cfg.unfoldAll=!0,a.each(b.allMenuObj,function(a){a.isLeaf||a.unfold||(a.unfold=!0,b.fire("unfold",{entity:a}))}),b._renderAndBindEvt()},foldAll:function(){var b=this;b.cfg.unfoldAll=!1,a.each(b.allMenuObj,function(a){!a.isLeaf&&a.unfold&&(a.unfold=!1,b.fire("fold",{entity:a}))}),b._renderAndBindEvt()},resetAll:function(){this.cfg=this.cfgCopy,this._init()},reload:function(a){this.cfg=a}}),d},{requires:["node","base","event","anim"]});